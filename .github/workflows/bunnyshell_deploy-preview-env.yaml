name: Bunnyshell - Deploy Preview Environment
concurrency: bns-deploy-${{ github.event.number || github.event.issue.number }}
on:
  workflow_call:
    inputs:
      git-ref:
        description: 'The git ref to use'
        type: string
        required: true
      argocd-image:
        description: 'ArgoCD image to use'
        type: string     
        required: true
        default: 'quay.io/argoproj/argocd:latest'
      bunnyshell-yaml-path:
        description: 'bunnyshell.yaml file to start from'
        type: string
        required: false
        default: .bunnyshell/templates/preview/bunnyshell.yaml
    secrets:
      bunnyshell_preview_password:
        required: true
      bunnyshell_access_token:
        required: true
      bunnyshell_app_private_key:
        required: false
      bunnyshell_mask_secret:
        required: true
  issue_comment:
    types: [ created, edited ]
jobs:
  prepare:
    permissions:
      contents: read
    runs-on: ubuntu-22.04
    outputs:
      bunnyshell-yaml-contents: ${{ steps.prepare-bunnyshell-yaml.outputs.contents }}
      git-sha: ${{ steps.prepare-vars.outputs.git-sha }}
    steps:
      - name: setup-yq
        uses: frenck/action-setup-yq@c4b5be8b4a215c536a41d436757d9feb92836d4f # v1.0.2
      - name: Check out the repo
        uses: actions/checkout@8e5e7e5ab8b370d6c329ec480221332ada57f0ab # v3.3.0
        with:
          ref: ${{ inputs.git-ref || format('refs/pull/{0}/head', github.event.issue.number) }}
          fetch-depth: 0
      - name: Prepare vars
        id: prepare-vars
        run: |
          BNS_GIT_SHA=`git rev-parse --short HEAD`

          echo "BNS_GIT_SHA=$BNS_GIT_SHA" >> "$GITHUB_ENV"

          echo "BNS_BUNNYSHELL_YAML_PATH=${{ inputs.bunnyshell-yaml-path || '.bunnyshell/templates/preview/bunnyshell.yaml' }}" >> "$GITHUB_ENV"
          echo "BNS_ARGOCD_IMAGE=${{ inputs.argocd-image || 'quay.io/argoproj/argocd:latest' }}" >> "$GITHUB_ENV" #todo: get it from artifacts

          echo "git-sha=$BNS_GIT_SHA" >> "$GITHUB_OUTPUT"
      - name: Prepare bunnyshell.yaml
        id: prepare-bunnyshell-yaml
        run: |
          set -e
  
          # update branch
          yq "(.components[] | select(.gitBranch != null)).gitBranch |= \"${{ env.BNS_GIT_SHA }}\"" ${{ env.BNS_BUNNYSHELL_YAML_PATH }} > bunnyshell_wf_updated.yaml

          # set environmentVariables
          yq -i ".environmentVariables.ARGOCD_IMAGE |= \"${{ env.BNS_ARGOCD_IMAGE }}\"" bunnyshell_wf_updated.yaml

          # set application variables
          yq -i "(.components[] | select(.name == \"argocd-ttyd\")).environment.ARGOCD_PASS |= \"bns_secret(${{ secrets.bunnyshell_preview_password }})\"" bunnyshell_wf_updated.yaml

          # encode the bunnyshell.yaml, as it contains secrets, to be able to pass it between jobs
          result=$(gpg --symmetric --cipher-algo AES256 --batch --passphrase "${{ secrets.bunnyshell_mask_secret }}" --output - bunnyshell_wf_updated.yaml | base64 -w0)
       
          # set outputs
          echo "contents=$result" >> "$GITHUB_OUTPUT"

  deploy:
    permissions:
      pull-requests: write
    name: Deploy Environment
    needs: prepare
    uses: bunnyshell/workflows/.github/workflows/deploy-env.yaml@main
    with:
      project-id: ${{ vars.BUNNYSHELL_PROJECT_ID }}
      cluster-id: ${{ vars.BUNNYSHELL_CLUSTER_ID }}
      env-name: 'ArgoCD PR #${{ github.event.number || github.event.issue.number }}'
      bunnyshell-yaml-contents: ${{ needs.prepare.outputs.bunnyshell-yaml-contents }}
      allowed-users: ${{ vars.BUNNYSHELL_ALLOWED_USERS }}
      comment-on-pr: true
      deploy-as-stopped: ${{ github.event_name == 'workflow_call' }}
      git-ref: ${{ needs.prepare.outputs.git-sha }}
      restricted-files: |
          .bunnyshell/*
      use-app-token: true
    secrets:
      bunnyshell-access-token: ${{ secrets.bunnyshell_access_token }}
      app-private-key: ${{ secrets.bunnyshell_app_private_key }}
      bunnyshell-yaml-contents-decryption-key: ${{ secrets.bunnyshell_mask_secret }}
